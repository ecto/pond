# FROG CAD Modeling Strategy (Python + Nix + uv)

This document outlines the chosen approach for creating and managing 3D CAD models for the FROG project.

## Core Choices

1.  **Modeling Library:** We will use the Python library **`build123d`** for defining parametric CAD models.
    - Model definitions reside in `.py` script files located in `crates/cad/models/`.
2.  **Base Environment Management:** **Nix** (via `flake.nix`) manages the core development environment, providing specific versions of:
    - The Rust toolchain (for the main project).
    - Python (e.g., Python 3.11).
    - `uv` (for Python package management).
    - Necessary system build tools (`cmake`, `clang`, `llvm`, `pkg-config`) required for compiling Python package native extensions.
    - Developers need Nix installed and should run commands within the environment provided by `nix develop`.
3.  **Python Dependency Management:** **`uv`** manages Python library dependencies (like `build123d`) within a virtual environment located at `.venv` in the workspace root.
    - The environment setup (creating `.venv`, installing deps via `uv pip install`) is handled automatically by the generation tool.
4.  **Generation Tool:** A dedicated Rust CLI tool, defined as a binary target named `generate-cad` within the `crates/cad` crate, is responsible for:
    - Ensuring the Python virtual environment exists and `build123d` is installed.
    - Finding all `.py` model scripts in `crates/cad/models/`.
    - Executing each script using the Python interpreter from the virtual environment (`.venv/bin/python`).
    - Passing target output paths for STEP and STL files as environment variables to the Python scripts.
5.  **Invocation:** CAD models are generated by running `cargo run --bin generate-cad` from the workspace root within the Nix shell. This is separate from the standard `cargo build` process.
6.  **Output Formats:** The Python scripts export models as **STEP (.step)** for manufacturing and **STL (.stl)** for visualization/simulation into the `target/cad/` directory.

## Rationale

This approach balances several factors:

- **Robust CAD Kernel:** Leverages the mature OpenCASCADE Technology (OCCT) kernel via `build123d` for reliable geometry operations and STEP export.
- **Python Ecosystem:** Utilizes the extensive Python ecosystem for CAD scripting.
- **Reproducible Base Environment:** Nix ensures the core build tools (Python version, compilers, `uv`) are consistent across developers.
- **Fast Python Tooling:** `uv` provides fast and modern virtual environment and package management for Python dependencies.
- **Isolation from Cargo Build:** Separating CAD generation into a distinct CLI tool avoids the difficult-to-debug issues encountered when running complex external processes (like Python dependency installation) directly from `build.rs`.
- **Version Control:** Python model scripts are version controlled naturally with Git.

## Challenges

- **Two-Step Process:** Developers need to remember to run `cargo run --bin generate-cad` separately from `cargo build` to update CAD outputs.
- **Python Dependencies:** While `uv` and Nix help, managing complex Python dependencies (especially those with C/C++ extensions) can still sometimes lead to build issues, although `build123d` seems more stable than `cadquery` in our tests.
- **Environment State:** The state of the `.venv` directory is managed implicitly. If major dependency changes occur, developers might need to manually run `make clean` (if we re-add it) or `rm -rf .venv` before regenerating models.
